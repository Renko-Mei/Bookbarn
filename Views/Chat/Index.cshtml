
@{
    ViewData["Title"] = "Chat";
}
<style>

    span.emotion { width: 42px; height: 20px; padding-left: 20px; cursor: pointer }
    span.emotion:hover { background-position: 2px -28px }
    .qqFace { margin-top: 4px; background: #fff; padding: 2px; border: 1px #dfe6f6 solid; }
    .qqFace table td { padding: 0px; }
    .qqFace table td img { cursor: pointer; border: 1px #fff solid; }
    .qqFace table td img:hover { border: 1px #0066cc solid; }
    .msg {
        position: absolute;
        top: 0;
        bottom: 30px;
        height: 80%;
        border: 1px solid black;
        margin-bottom: auto;
        display:block;
        overflow: scroll;
        width:100%;
        white-space:nowrap;
    }
    .col-md-8{
        height: 500px;
    }
    .col-md-4{
        height: 500px;
    }
    .input{
        margin-top: 400px;
        margin-right: 0px;
        width: 100%;
    }
    .text{
        max-width:unset;
        width:384px;
        padding: 10px;
        margin-left: 0px;
        
    }
    .emotion{
        
        margin-left: 0px;
        margin-top: 0px;
    }


    
</style>

<h2 style="margin-top:60px">Chat Room</h2>
<hr>
<div class="row">
     <div class="col-md-4">
         <p>whatever</p>
     </div>
     <div class="col-md-8">
        <div class="msg" >
             <div style="position:absolute; bottom:0;" id="msgs"></div>
        </div>
        <div class="input"> 
            <table>
                <tr>
                    <td >
                        <input type="text" class="text" id="MessageField" name="MessageField" placeholder="type message and press enter" />
                        
                    </td>
                    <td>
                        <span class="emotion">emoji</span>
                    </td>
                </tr>
            </table> 
             
            
           
              

        </div>
        
     </div>

</div>












@section Scripts {
    <script  src="~/js/jquery.min.js"></script>
    <script type="text/javascript" src="~/js/jquery.qqFace.js"></script>
    <script> 
        window.onload=function()
        { 
            if(document.readyState=="complete")
            {
                document.getElementById("MessageField").focus(); 
            }
        }

        $('.emotion').qqFace({
            id : 'facebox', 
            assign: 'MessageField', 
            path:'arclist/'	
        });

        var userName = "@ViewData["UserName"]";
        var historicalMessage = @Html.Raw(@ViewBag.historicalMessage);
        var historicalBar = "--------------------------history-------------------------";
        if (historicalMessage.length != 0){
            for (var i = 0; i < historicalMessage.length; i++) {
                $('#msgs').append(replace_em(historicalMessage[i]) + '<br />');
            };
            $('#msgs').append(historicalBar + '<br />');
        }

    var wsUri = `ws://${window.location.host}/ws`;
        var socket = new WebSocket(wsUri);

        

        socket.onopen = e => {
            var welcomeMessage = `[SYSTEM]: Welcome ${userName}!`
            socket.send(welcomeMessage);
            console.log("socket opened", e);
        };

        socket.onclose = function (e) {
            console.log("socket closed", e);
        };

        socket.onmessage = function (e) {
            console.log(e);
            $('#msgs').append(replace_em(e.data) + '<br />');
        };

        socket.onerror = function (e) {
            console.error(e.data);
        };

        $('#MessageField').keypress(function (e) {

            if (e.which != 13) {
                return;
            }

            e.preventDefault();
            var str = $('#MessageField').val();
            var message = `${userName}: ${str}`;
            socket.send(message);
            $('#MessageField').val('');
            document.getElementById("MessageField").focus();
        });

        function replace_em(str){
            str = str.replace(/\</g,'&lt;');
            str = str.replace(/\>/g,'&gt;');
            str = str.replace(/\n/g,'<br/>');
            str = str.replace(/\[em_([0-9]*)\]/g,'<img src="arclist/$1.gif" border="0" />');
            return str;
        }

        function dbClose(){
            socket.close();
        }


    </script>
}
